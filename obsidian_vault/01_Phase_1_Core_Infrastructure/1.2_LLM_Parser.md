# 1.2 LLM Parser
Status: - [x] Completed

## Description
Create the natural language parsing engine that uses Anthropic Claude to interpret user messages and extract structured event data as JSON. This is the brain of the Capture System — every text or voice message flows through this parser before reaching Google Calendar.

## Files to Create/Edit
- [ ] `src/core/parser.py`

## Prompt for Claude
```
You are building **LifeOS Assistant**. This module is the **brain of the Capture System** — it converts natural language (Hebrew or English) into structured calendar events. Every text or voice message the user sends passes through this parser.

Key design decision: The parser ALWAYS outputs a calendar event. There is no intent routing. Chores are added only via the explicit `/addchore` command, so the parser never needs to distinguish between event types.

Create `src/core/parser.py` with the following:

1. Define a Pydantic model `ParsedEvent` with fields:
   - event: str          # name/title of the event
   - date: str           # ISO format YYYY-MM-DD
   - time: str           # HH:MM in 24h format
   - duration_minutes: int (default 60)
   - description: str    (default "")

   This is the **shared JSON contract** consumed by `2.2_Event_Writer` and `3.3_Main_Logic`:
   ```json
   {
     "event": "Dentist appointment",
     "date": "2025-02-14",
     "time": "16:00",
     "duration_minutes": 60,
     "description": ""
   }
   ```

2. Create an async function `parse_message(user_message: str) -> ParsedEvent | None`:
   - Use the **Anthropic Python SDK** (`anthropic.AsyncAnthropic`).
   - Use model: "claude-haiku-4-5-20251001" (fast + cheap for structured extraction).
   - Send a system prompt instructing Claude to extract event details from natural language.
   - The system prompt should tell Claude to use TODAY's date as reference for relative dates like "tomorrow", "next Monday", etc.
   - Request the response in JSON format matching the ParsedEvent schema above.
   - Parse the JSON response into a ParsedEvent object.
   - Return None if the message doesn't contain event information.
   - Handle API errors gracefully with logging.

3. The system prompt should handle Hebrew and English input, and understand common patterns like:
   - "Schedule a meeting tomorrow at 3pm"
   - "Dentist appointment next Tuesday 10:00"
   - "קביעת פגישה מחר ב-15:00"
   - "ארוחת ערב עם דנה ביום שישי"

4. Include proper logging using Python's `logging` module.

Use `from src.config import settings` for the API key (`settings.ANTHROPIC_API_KEY`).

IMPORTANT: Do NOT use the OpenAI SDK here. All LLM calls use the Anthropic SDK. OpenAI is reserved only for Whisper transcription in `3.2_Voice_Handling`.
```

## Implementation Logs
- **Commit:** `2c4be37` — feat(core): 1.2 LLM Parser
- **Files created:**
  - `src/core/parser.py` — ParsedEvent model + parse_message() with Anthropic Claude
